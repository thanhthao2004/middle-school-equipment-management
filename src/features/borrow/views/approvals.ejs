<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <style>
    body { font-family: Arial; margin: 20px; }
    h1 { margin-bottom: 16px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn { padding: 6px 12px; border: 1px solid #ccc; background: #f3f3f3; cursor: pointer; }
    .tab-btn.active { background: #007bff; color: white; border-color: #007bff; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f5f5f5; text-align: left; }
    button { border: none; padding: 6px 10px; color: white; border-radius: 4px; cursor: pointer; }
    .btn-approve { background: #28a745; }
    .btn-reject { background: #dc3545; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1><%= title %></h1>
  <p>Người dùng: <strong><%= user.name %></strong> (<%= user.role %>)</p>

  <div class="tabs">
    <button class="tab-btn active" data-tab="borrow">Phiếu mượn</button>
    <button class="tab-btn" data-tab="return">Phiếu trả</button>
  </div>

  <div id="tab-borrow">
    <table>
      <thead>
        <tr><th>Mã phiếu</th><th>Ngày tạo</th><th>Ghi chú</th><th>Thao tác</th></tr>
      </thead>
      <tbody id="borrowBody"></tbody>
    </table>
  </div>

  <div id="tab-return" class="hidden">
    <table>
      <thead>
        <tr><th>Mã phiếu trả</th><th>Phiếu mượn</th><th>Ngày trả</th><th>Thao tác</th></tr>
      </thead>
      <tbody id="returnBody"></tbody>
    </table>
  </div>

  <script>
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabBorrow = document.getElementById('tab-borrow');
    const tabReturn = document.getElementById('tab-return');
    const borrowBody = document.getElementById('borrowBody');
    const returnBody = document.getElementById('returnBody');

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (btn.dataset.tab === 'borrow') {
          tabBorrow.classList.remove('hidden');
          tabReturn.classList.add('hidden');
          loadBorrow();
        } else {
          tabBorrow.classList.add('hidden');
          tabReturn.classList.remove('hidden');
          loadReturn();
        }
      });
    });

    async function loadBorrow() {
      borrowBody.innerHTML = '<tr><td colspan="4">Đang tải...</td></tr>';
      const res = await fetch('/borrow/api/borrow/pending');
      const json = await res.json();
      borrowBody.innerHTML = '';
      json.data.forEach(b => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${b.id}</td>
          <td>${b.createdAt}</td>
          <td>${b.note}</td>
          <td>
            <button class="btn-approve">Duyệt</button>
            <button class="btn-reject">Từ chối</button>
          </td>`;
        tr.querySelector('.btn-approve').onclick = () => action('borrow', 'approve', b.id);
        tr.querySelector('.btn-reject').onclick = () => action('borrow', 'reject', b.id);
        borrowBody.appendChild(tr);
      });
    }

    async function loadReturn() {
      returnBody.innerHTML = '<tr><td colspan="4">Đang tải...</td></tr>';
      const res = await fetch('/borrow/api/return/pending');
      const json = await res.json();
      returnBody.innerHTML = '';
      json.data.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.maPhieuMuon}</td>
          <td>${r.ngayTra}</td>
          <td>
            <button class="btn-approve">Duyệt</button>
            <button class="btn-reject">Từ chối</button>
          </td>`;
        tr.querySelector('.btn-approve').onclick = () => action('return', 'approve', r.id);
        tr.querySelector('.btn-reject').onclick = () => action('return', 'reject', r.id);
        returnBody.appendChild(tr);
      });
    }

    async function action(type, act, id) {
      const ok = confirm(`${act === 'approve' ? 'Duyệt' : 'Từ chối'} ${type === 'borrow' ? 'phiếu mượn' : 'phiếu trả'} ${id}?`);
      if (!ok) return;
      await fetch(`/borrow/api/${type}/${act}/${id}`, { method: 'POST' });
      alert('Đã xử lý!');
      if (type === 'borrow') loadBorrow(); else loadReturn();
    }

    loadBorrow();
  </script>
</body>
</html>
