<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof title !== 'undefined' ? title : 'Chi tiết Phiếu Mượn' %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/stylesheets/style.css" rel="stylesheet">
    <style>
        .slip-box { 
            border: 1px solid #ddd; 
            padding: 20px; 
            border-radius: 8px; 
            background-color: #f9f9f9; 
            max-width: 1000px; 
            margin: 20px auto; 
        }
        .slip-info { 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin-bottom: 20px; 
            font-size: 1.1rem; 
            background-color: white;
            border-radius: 4px;
        }
        .equipment-table th, .equipment-table td { 
            font-size: 0.85rem; 
            padding: 8px; 
        }
        .equipment-table th { 
            background-color: #e9ecef; 
        }
        .btn-approve { 
            background-color: #28a745; 
            color: white; 
        }
        .btn-reject { 
            background-color: #dc3545; 
            color: white; 
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <% const userObj = (typeof user !== 'undefined' && user) ? user : { role: 'ql_thiet_bi' }; %>
    <div class="app-shell">
        <%- include('../../../../views/partials/qltb-sidebar', { currentPage: 'borrow-approvals', user: userObj }) %>
        
        <div class="main-content">
            <%- include('../../../../views/partials/header', { currentPage: 'borrow-approvals', user: userObj }) %>
            
            <div class="container-fluid py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">CHI TIẾT PHIẾU MƯỢN THIẾT BỊ</h1>
                    <a href="/manager/borrow/approvals" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Quay lại
                    </a>
                </div>

                <% if (typeof slip !== 'undefined' && slip) { %>
                <div class="slip-box">
                    <h4 class="text-center mb-4">Phiếu Mượn</h4>
                    
                    <!-- Thông tin Phiếu Mượn -->
                    <div class="slip-info mb-3">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Mã Phiếu:</strong> <span id="slipId"><%= slip.maPhieu %></span></p>
                                <p><strong>Giáo viên mượn:</strong> <%= slip.nguoiLapPhieuId?.hoTen || 'N/A' %></p>
                                <p><strong>Ngày tạo phiếu:</strong> <%= slip.createdAt ? new Date(slip.createdAt).toLocaleString('vi-VN') : '-' %></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Ngày mượn:</strong> <%= slip.ngayMuon ? new Date(slip.ngayMuon).toLocaleDateString('vi-VN') : '-' %></p>
                                <p><strong>Ngày trả dự kiến:</strong> <%= slip.ngayDuKienTra ? new Date(slip.ngayDuKienTra).toLocaleDateString('vi-VN') : '-' %></p>
                                <p><strong>Ca mượn:</strong> <%= slip.caMuon === 'sang' ? 'Sáng' : 'Chiều' %></p>
                                <p><strong>Ca trả:</strong> <%= slip.caTra === 'sang' ? 'Sáng' : 'Chiều' %></p>
                            </div>
                        </div>
                        <p><strong>Lý do:</strong> <%= slip.lyDo || '-' %></p>
                        <p><strong>Trạng thái:</strong> 
                            <% 
                            const statusMap = {
                                'cho_duyet': { text: 'Chờ duyệt', class: 'bg-warning text-dark' },
                                'approved': { text: 'Đã duyệt', class: 'bg-success' },
                                'dang_muon': { text: 'Đang mượn', class: 'bg-info' },
                                'rejected': { text: 'Từ chối', class: 'bg-danger' },
                                'da_tra_mot_phan': { text: 'Đã trả một phần', class: 'bg-primary' },
                                'da_hoan_tat': { text: 'Đã hoàn tất', class: 'bg-secondary' },
                                'huy': { text: 'Đã hủy', class: 'bg-dark' }
                            };
                            const statusInfo = statusMap[slip.trangThai] || { text: slip.trangThai, class: 'bg-secondary' };
                            %>
                            <span class="badge status-badge <%= statusInfo.class %>"><%= statusInfo.text %></span>
                        </p>
                        <% if (slip.ghiChu) { %>
                        <p><strong>Ghi chú:</strong> <%= slip.ghiChu %></p>
                        <% } %>
                    </div>

                    <!-- Chi tiết Thiết bị mượn -->
                    <h6>Thiết bị mượn:</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered equipment-table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Mã TB</th>
                                    <th>Tên Thiết Bị</th>
                                    <th>Danh mục</th>
                                    <th>Số lượng mượn</th>
                                    <th>Đơn vị đã mượn</th>
                                    <th>Ngày trả dự kiến</th>
                                    <th>Tình trạng lúc mượn</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (slip.details && slip.details.length > 0) { %>
                                    <% slip.details.forEach((detail, index) => { %>
                                    <tr>
                                        <td><%= index + 1 %></td>
                                        <td><%= detail.maTB %></td>
                                        <td><%= detail.device?.tenTB || detail.maTB %></td>
                                        <td><%= detail.device?.category?.name || detail.device?.category?.tenDM || '-' %></td>
                                        <td><%= detail.soLuongMuon %></td>
                                        <td>
                                            <% if (detail.danhSachDonVi && detail.danhSachDonVi.length > 0) { %>
                                                <%= detail.danhSachDonVi.join(', ') %>
                                            <% } else { %>
                                                -
                                            <% } %>
                                        </td>
                                        <td><%= detail.ngayTraDuKien ? new Date(detail.ngayTraDuKien).toLocaleDateString('vi-VN') : '-' %></td>
                                        <td><%= detail.tinhTrangLucMuon || '-' %></td>
                                        <td><%= detail.ghiChu || '-' %></td>
                                    </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="9" class="text-center text-muted">Không có thiết bị nào</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>

                    <!-- Action Buttons -->
                    <% if (slip.trangThai === 'cho_duyet') { %>
                    <div class="text-center mt-4 d-flex justify-content-center gap-3">
                        <button class="btn btn-approve px-4" onclick="handleAction('approve')">
                            <i class="fas fa-check me-1"></i>Duyệt
                        </button>
                        <button class="btn btn-reject px-4" onclick="handleAction('reject')">
                            <i class="fas fa-times me-1"></i>Không duyệt
                        </button>
                        <button class="btn btn-secondary px-4" onclick="window.history.back()">
                            <i class="fas fa-arrow-left me-1"></i>Đóng
                        </button>
                    </div>
                    <% } else { %>
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary px-4" onclick="window.history.back()">
                            <i class="fas fa-arrow-left me-1"></i>Quay lại
                        </button>
                    </div>
                    <% } %>
                </div>
                <% } else { %>
                <div class="alert alert-warning">
                    Không tìm thấy phiếu mượn
                </div>
                <% } %>
            </div>
            
            <%- include('../../../../views/partials/footer', { currentPage: 'borrow-approvals', user: userObj }) %>
        </div>
    </div>

    <!-- Modal Xác nhận -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Xác nhận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    <!-- Content will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="confirmBtn">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const slipId = '<%= typeof slip !== "undefined" && slip ? slip.maPhieu : "" %>';
        const slipStatus = '<%= typeof slip !== "undefined" && slip ? slip.trangThai : "" %>';

        function handleAction(actionType) {
            const actionText = actionType === 'approve' ? 'duyệt' : 'KHÔNG duyệt';
            
            if (actionType === 'reject') {
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                document.getElementById('confirmModalTitle').textContent = 'Xác nhận từ chối phiếu mượn';
                document.getElementById('confirmModalBody').innerHTML = `
                    <p>Bạn có chắc chắn muốn từ chối phiếu mượn <strong>${slipId}</strong> không?</p>
                    <div class="mb-3">
                        <label for="rejectReason" class="form-label">Lý do từ chối:</label>
                        <textarea id="rejectReason" class="form-control" rows="3" placeholder="Nhập lý do từ chối..."></textarea>
                    </div>
                `;
                
                document.getElementById('confirmBtn').onclick = function() {
                    rejectBorrow();
                };
                
                modal.show();
            } else {
                if (confirm(`Bạn có chắc chắn muốn ${actionText} phiếu mượn ${slipId} này không?`)) {
                    approveBorrow();
                }
            }
        }

        async function approveBorrow() {
            try {
                const response = await fetch(`/manager/borrow/approvals/${slipId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('Đã duyệt phiếu mượn thành công!');
                    window.location.href = '/manager/borrow/approvals';
                } else {
                    alert('Lỗi: ' + (result.message || 'Không thể duyệt phiếu mượn'));
                }
            } catch (error) {
                console.error('Error approving borrow:', error);
                alert('Lỗi khi duyệt phiếu mượn');
            }
        }

        async function rejectBorrow() {
            const reason = document.getElementById('rejectReason')?.value || 'Không rõ lý do';
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));

            try {
                const response = await fetch(`/manager/borrow/approvals/${slipId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Đã từ chối phiếu mượn thành công!');
                    modal.hide();
                    window.location.href = '/manager/borrow/approvals';
                } else {
                    alert('Lỗi: ' + (result.message || 'Không thể từ chối phiếu mượn'));
                }
            } catch (error) {
                console.error('Error rejecting borrow:', error);
                alert('Lỗi khi từ chối phiếu mượn');
            }
        }
    </script>
</body>
</html>
