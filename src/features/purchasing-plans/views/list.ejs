<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/public/stylesheets/style.css" rel="stylesheet">
    <style>
        /* local small overrides if needed */
        .action-btn {
            min-width: 40px;
            text-align: center
        }
    </style>
</head>

<body>
    <div class="app-shell">
        <aside class="sidebar" role="navigation" aria-label="Main menu">
            <div class="menu-title">‚ò∞ &nbsp; B·∫¢NG CH·ªåN</div>
            <nav class="menu">
                <a href="/reports/device-stats" class="nav-link">
                    <span class="icon">üìä</span>
                    <span class="text">Xem b√°o c√°o th·ªëng k√™ thi·∫øt b·ªã h·ªèng</span>
                </a>
                <a href="/training-plans" class="nav-link">
                    <span class="icon">üìÖ</span>
                    <span class="text">Xem k·∫ø ho·∫°ch ƒë√†o t·∫°o</span>
                </a>
                <a href="/purchasing-plans" class="nav-link active">
                    <span class="icon">üõí</span>
                    <span class="text">Qu·∫£n l√Ω k·∫ø ho·∫°ch mua s·∫Øm</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>Qu·∫£n l√Ω k·∫ø ho·∫°ch mua s·∫Øm thi·∫øt b·ªã</h1>
            </div>

            <div class="controls">
                <div class="left">
                    <select id="year-filter" class="form-select search-select" aria-label="NƒÉm h·ªçc">
                        <option value="">NƒÉm h·ªçc</option>
                        <% if (years && years.length) { %>
                            <% years.forEach(function(y){ %>
                                <option value="<%= y %>">
                                    <%= y %>
                                </option>
                                <% }); %>
                                    <% } %>
                    </select>
                    <button id="year-filter-btn" class="btn btn-outline-primary"><span
                            class="search-icon">üîç</span></button>
                </div>

                <div>
                    <a href="/purchasing-plans/create" class="btn-register">+ L·∫≠p k·∫ø ho·∫°ch mua s·∫Øm m·ªõi</a>
                </div>
            </div>

            <div class="card card-table">
                <div class="card-body">
                    <% if (plans && plans.length) { %>
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>M√£ k·∫ø ho·∫°ch</th>
                                        <th>NƒÉm h·ªçc</th>
                                        <th>Tr·∫°ng th√°i</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% plans.forEach(function(plan){ %>
                                        <tr data-year="<%= plan.schoolYear %>">
                                            <td>
                                                <%= plan.code %>
                                            </td>
                                            <td>
                                                <%= plan.schoolYear %>
                                            </td>
                                            <td>
                                                <% if (plan.status==='approved' ) { %>
                                                    <span class="status-badge status-available">ƒê√£ duy·ªát</span>
                                                    <% } else if (plan.status==='pending' ) { %>
                                                        <span class="status-badge status-pending">ƒêang ch·ªù duy·ªát</span>
                                                        <% } else if (plan.status==='rejected' ) { %>
                                                            <span class="status-badge status-rejected">T·ª´ ch·ªëi</span>
                                                            <% } else { %>
                                                                <span class="status-badge status-borrowed">
                                                                    <%= plan.status %>
                                                                </span>
                                                                <% } %>
                                            </td>
                                            <td class="float-right">
                                                <a href="/purchasing-plans/<%= plan.id %>" class="action-btn"
                                                    title="Xem">üëÅÔ∏è</a>
                                                <% if (plan.status==='pending' ) { %>
                                                    <a href="/purchasing-plans/<%= plan.id %>/edit" class="action-btn"
                                                        title="S·ª≠a">‚úèÔ∏è</a>
                                                    <form action="/purchasing-plans/<%= plan.id %>?_method=DELETE"
                                                        method="post" style="display:inline-block" class="delete-form">
                                                        <!-- use a button that triggers the confirmation modal -->
                                                        <button type="button" class="btn-cancel delete-btn"
                                                            data-plan-code="<%= plan.code %>" title="X√≥a">üóëÔ∏è</button>
                                                    </form>
                                                    <% } %>
                                            </td>
                                        </tr>
                                        <% }); %>
                                </tbody>
                            </table>
                        </div>
                        <div id="no-results" class="alert alert-warning mt-3" style="display:none">Kh√¥ng c√≥ k·∫ø ho·∫°ch mua
                            s·∫Øm cho nƒÉm h·ªçc ƒë√£ ch·ªçn.</div>
                        <% } else { %>
                            <div class="alert alert-info">Ch∆∞a c√≥ k·∫ø ho·∫°ch mua s·∫Øm n√†o.</div>
                            <% } %>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/bootstrap.bundle.min.js"></script>
    <!-- Confirmation modal for delete actions -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteLabel">X√°c nh·∫≠n x√≥a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a K·∫ø ho·∫°ch mua s·∫Øm n√†y kh√¥ng?
                    <div id="modal-plan-code" class="mt-2 fw-bold"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" id="confirm-delete" class="btn btn-danger">X√≥a</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const deleteModalEl = document.getElementById('confirmDeleteModal');
            let deleteModal = null;
            try {
                deleteModal = new bootstrap.Modal(deleteModalEl);
            } catch (e) {
                // bootstrap not available or error; fallback to native confirm later
                deleteModal = null;
            }

            let formToSubmit = null;

            document.addEventListener('click', function (e) {
                const target = e.target;
                if (target && target.classList.contains('delete-btn')) {
                    // find the parent form
                    const form = target.closest('form');
                    const planCode = target.getAttribute('data-plan-code') || '';
                    if (deleteModal) {
                        formToSubmit = form;
                        const codeEl = document.getElementById('modal-plan-code');
                        codeEl.textContent = planCode ? `M√£ k·∫ø ho·∫°ch: ${planCode}` : '';
                        deleteModal.show();
                    } else {
                        // fallback to native confirm
                        const ok = confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a K·∫ø ho·∫°ch mua s·∫Øm n√†y kh√¥ng?');
                        if (ok && form) form.submit();
                    }
                }
            });

            const confirmBtn = document.getElementById('confirm-delete');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function () {
                    if (formToSubmit) formToSubmit.submit();
                });
            }
        })();
    </script>
    <script>
        // Year filter: show only rows that match selected year
        (function () {
            const yearSelect = document.getElementById('year-filter');
            const yearBtn = document.getElementById('year-filter-btn');
            const noResults = document.getElementById('no-results');

            function filterByYear(year) {
                const rows = document.querySelectorAll('table tbody tr[data-year]');
                let any = false;
                rows.forEach(r => {
                    const y = r.getAttribute('data-year') || '';
                    if (!year || year === '') {
                        r.style.display = '';
                        any = true;
                    } else if (y === year) {
                        r.style.display = '';
                        any = true;
                    } else {
                        r.style.display = 'none';
                    }
                });
                if (noResults) noResults.style.display = any ? 'none' : 'block';
            }

            // Only filter when user clicks the search button.
            if (yearBtn) {
                yearBtn.addEventListener('click', function () {
                    filterByYear(yearSelect ? yearSelect.value : '');
                });
            }
        })();
    </script>
</body>

</html>