<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách thiết bị</title>

    <!-- Bootstrap 5.3.0 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 6.4.0 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/devices.css">
    <link rel="stylesheet" href="/stylesheets/style.css">
</head>

<body>
    <!-- Header -->
    <%- include('../../../views/partials/header', { currentPage: 'devices' , user: typeof user !=='undefined' ? user : { role: 'ql_thiet_bi' } }) %>

    <!-- Main Layout with Sidebar -->
    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Sidebar QLTB -->
            <%- include('../../../views/partials/qltb-sidebar', { currentPage: 'devices' , user: typeof user !=='undefined' ? user : { role: 'ql_thiet_bi' } }) %>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="container-fluid py-4">
                    <!-- Page Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="h3 mb-0">DANH SÁCH THIẾT BỊ</h1>
                        <div class="d-flex gap-2">
                            <a href="/manager/devices/create" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Thêm mới
                            </a>
                             <!-- Additional buttons can be added here -->
                        </div>
                    </div>

                    <!-- Flash Messages -->
                    <% if (typeof messages !=='undefined' && messages.success) { %>
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <%= messages.success %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    <% } %>
                    <% if (typeof messages !=='undefined' && messages.error) { %>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <%= messages.error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    <% } %>

                    <!-- Filters -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <form action="/manager/devices" method="GET" class="row g-3" id="filterForm">
                                
                                <!-- Search -->
                                <div class="col-12 col-md-6 col-lg-3">
                                    <label for="search" class="form-label">Tìm kiếm</label>
                                    <input type="text" class="form-control" id="search" name="search"
                                        placeholder="Tên hoặc mã thiết bị..."
                                        value="<%= typeof filters !== 'undefined' ? filters.search : '' %>">
                                </div>

                                <!-- Category -->
                                <div class="col-12 col-md-6 col-lg-3">
                                    <label for="categoryId" class="form-label">Danh mục</label>
                                    <select class="form-select" id="categoryId" name="categoryId">
                                        <option value="">Tất cả</option>
                                        <% if (typeof categories !=='undefined' && categories.length > 0) { %>
                                            <% categories.forEach(cat => { %>
                                                <option value="<%= cat._id %>" 
                                                    <%= (typeof filters !== 'undefined' && filters.categoryId === cat._id.toString()) ? 'selected' : '' %>>
                                                    <%= cat.name || cat.tenDM %>
                                                </option>
                                            <% }); %>
                                        <% } %>
                                    </select>
                                </div>

                                <!-- Status -->
                                <div class="col-12 col-md-6 col-lg-2">
                                    <label for="status" class="form-label">Tình trạng</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="">Tất cả</option>
                                        <% 
                                            const uniqueStatuses = new Set(['Tốt', 'Khá', 'Trung bình', 'Hỏng']); 
                                            if (typeof filterOptions !== 'undefined' && filterOptions && filterOptions.statuses) {
                                                filterOptions.statuses.forEach(s => uniqueStatuses.add(s));
                                            }
                                        %>
                                        <% Array.from(uniqueStatuses).forEach(status => { %>
                                            <option value="<%= status %>"
                                                <%= (typeof filters !== 'undefined' && filters.tinhTrangThietBi === status) ? 'selected' : '' %>>
                                                <%= status %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>

                                <!-- Location -->
                                <div class="col-12 col-md-6 col-lg-2">
                                    <label for="location" class="form-label">Vị trí</label>
                                    <select class="form-select" id="location" name="location">
                                        <option value="">Tất cả</option>
                                        <% if (typeof filterOptions !== 'undefined' && filterOptions && filterOptions.locations) { %>
                                            <% filterOptions.locations.forEach(loc => { %>
                                                <option value="<%= loc %>"
                                                    <%= (typeof filters !== 'undefined' && filters.viTriLuuTru === loc) ? 'selected' : '' %>>
                                                    <%= loc %>
                                                </option>
                                            <% }); %>
                                        <% } %>
                                    </select>
                                </div>

                                <!-- Origin -->
                                <div class="col-12 col-md-6 col-lg-2">
                                    <label for="origin" class="form-label">Nguồn gốc</label>
                                    <select class="form-select" id="origin" name="origin">
                                        <option value="">Tất cả</option>
                                        <% 
                                            const allOrigins = new Set();
                                            if (typeof filterOptions !== 'undefined' && filterOptions && filterOptions.origins) {
                                                filterOptions.origins.forEach(o => allOrigins.add(o));
                                            }
                                            ['Mua mới', 'Tài trợ', 'Hiến tặng', 'Giáo viên tự làm'].forEach(o => allOrigins.add(o));
                                        %>
                                        <% Array.from(allOrigins).sort().forEach(orig => { %>
                                            <option value="<%= orig %>"
                                                <%= (typeof filters !== 'undefined' && filters.nguonGoc === orig) ? 'selected' : '' %>>
                                                <%= orig %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>

                                <!-- Buttons -->
                                <div class="col-12 d-flex gap-2 justify-content-end">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Lọc
                                    </button>
                                    <a href="/manager/devices" class="btn btn-outline-secondary">
                                        <i class="fas fa-times"></i> Xóa bộ lọc
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Devices Table -->
                                            <div class="card">
                                                <div class="card-body p-0">
                                                    <div class="table-responsive">
                                                        <table class="table table-hover mb-0">
                                                            <thead>
                                                                <tr>
                                                                    <th>Mã TB</th>
                                                                    <th>Hình ảnh</th>
                                                                    <th>Tên thiết bị</th>
                                                                    <th>Danh mục</th>
                                                                    <th>Số lượng</th>
                                                                    <th>Giá thành</th>
                                                                    <th>Tình trạng</th>
                                                                    <th>Vị trí</th>
                                                                    <th>Nhà cung cấp</th>
                                                                    <th>Ngày nhập</th>
                                                                    <th>Thao tác</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <% if (devices && devices.length> 0) { %>
                                                                    <% devices.forEach(device=> { %>
                                                                        <tr>
                                                                            <td>
                                                                                <span class="code-box">
                                                                                    <%= device.maTB || '' %>
                                                                                </span>
                                                                            </td>
                                                                            <td>
                                                                                <% let hasImage=false; let imageUrl='' ;
                                                                                    if (device.hinhAnh) { if
                                                                                    (Array.isArray(device.hinhAnh) &&
                                                                                    device.hinhAnh.length> 0) {
                                                                                    imageUrl = device.hinhAnh[0];
                                                                                    hasImage = true;
                                                                                    } else if (typeof device.hinhAnh ===
                                                                                    'string' && device.hinhAnh) {
                                                                                    imageUrl = device.hinhAnh;
                                                                                    hasImage = true;
                                                                                    }
                                                                                    }

                                                                                    if (hasImage) { %>
                                                                                    <img src="<%= imageUrl %>"
                                                                                        alt="<%= device.tenTB %>"
                                                                                        style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"
                                                                                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                                                    <div
                                                                                        style="display: none; width: 50px; height: 50px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; align-items: center; justify-content: center;">
                                                                                        <i
                                                                                            class="fas fa-image text-muted"></i>
                                                                                    </div>
                                                                                    <% } else { %>
                                                                                        <div
                                                                                            style="display: flex; width: 50px; height: 50px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; align-items: center; justify-content: center;">
                                                                                            <i
                                                                                                class="fas fa-image text-muted"></i>
                                                                                        </div>
                                                                                        <% } %>
                                                                            </td>
                                                                            <td>
                                                                                <%= device.tenTB || '' %>
                                                                            </td>
                                                                            <td>
                                                                                <% if (device.category &&
                                                                                    (device.category.name ||
                                                                                    device.category.tenDM)) { %>
                                                                                    <%= device.category.name ||
                                                                                        device.category.tenDM %>
                                                                                        <% } else if (device.maDM) { %>
                                                                                            <%= device.maDM %>
                                                                                                <% } else { %>
                                                                                                    <span
                                                                                                        class="text-muted">-</span>
                                                                                                    <% } %>
                                                                            </td>
                                                                            <td>
                                                                                <%= device.soLuong || 0 %>
                                                                            </td>
                                                                            <td>
                                                                                <% if (device.giaThanh) { %>
                                                                                    <%= device.giaThanh.toLocaleString('vi-VN')
                                                                                        %>đ
                                                                                        <% } else { %>
                                                                                            <span
                                                                                                class="text-muted">-</span>
                                                                                            <% } %>
                                                                            </td>
                                                                            <td>
                                                                                <% if (device.conditionStats) { const
                                                                                    colorMap={ 'Tốt' : 'success' , 'Khá'
                                                                                    : 'primary' , 'Trung bình'
                                                                                    : 'warning' , 'Hỏng' : 'danger' };
                                                                                    let hasStats=false;
                                                                                    Object.entries(device.conditionStats).forEach(([status,
                                                                                    count])=> {
                                                                                    if (count > 0) {
                                                                                    hasStats = true;
                                                                                    %>
                                                                                    <span
                                                                                        class="badge bg-<%= colorMap[status] || 'secondary' %> mb-1 d-inline-block">
                                                                                        <%= status %>: <%= count %>
                                                                                    </span>
                                                                                    <% } }); if (!hasStats) { %>
                                                                                        <span
                                                                                            class="status-badge status-available">
                                                                                            <%= device.tinhTrangThietBi
                                                                                                || 'Tốt' %>
                                                                                        </span>
                                                                                        <% } } else { %>
                                                                                            <span
                                                                                                class="status-badge status-available">
                                                                                                <%= device.tinhTrangThietBi
                                                                                                    || 'Tốt' %>
                                                                                            </span>
                                                                                            <% } %>
                                                                            </td>
                                                                            <td>
                                                                                <%= device.viTriLuuTru || '-' %>
                                                                            </td>
                                                                            <td>
                                                                                <% if (device.supplier &&
                                                                                    device.supplier.name) { %>
                                                                                    <%= device.supplier.name %>
                                                                                        <% } else { %>
                                                                                            <span
                                                                                                class="text-muted">-</span>
                                                                                            <% } %>
                                                                            </td>
                                                                            <td>
                                                                                <% if (device.ngayNhap) { %>
                                                                                    <%= new
                                                                                        Date(device.ngayNhap).toLocaleDateString('vi-VN')
                                                                                        %>
                                                                                        <% } else { %>
                                                                                            <span
                                                                                                class="text-muted">-</span>
                                                                                            <% } %>
                                                                            </td>
                                                                            <td>
                                                                                <div class="btn-group btn-group-sm"
                                                                                    role="group">
                                                                                    <a href="/manager/devices/detail/<%= device._id %>"
                                                                                        class="btn btn-outline-primary"
                                                                                        title="Xem chi tiết">
                                                                                        <i class="fas fa-eye"></i>
                                                                                    </a>
                                                                                    <a href="/manager/devices/edit/<%= device._id %>"
                                                                                        class="btn btn-outline-warning"
                                                                                        title="Sửa">
                                                                                        <i class="fas fa-edit"></i>
                                                                                    </a>
                                                                                    <a href="/manager/devices/delete/<%= device._id %>"
                                                                                        class="btn btn-outline-danger btn-delete"
                                                                                        data-id="<%= device._id %>"
                                                                                        data-name="<%= device.tenTB %>"
                                                                                        title="Xóa">
                                                                                        <i class="fas fa-trash-alt"></i>
                                                                                    </a>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        <% }); %>
                                                                            <% } else { %>
                                                                                <tr>
                                                                                    <td colspan="9"
                                                                                        class="text-center py-4">
                                                                                        <div class="text-muted">
                                                                                            <i
                                                                                                class="fas fa-inbox fa-2x mb-2"></i>
                                                                                            <p class="mb-0">Không tìm
                                                                                                thấy thiết bị nào</p>
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                                <% } %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                        </div>
                    </div>
            </div>
        </div>

        <!-- Footer -->
        <%- include('../../../views/partials/footer') %>

            <!-- Delete Modal -->
            <div id="deleteModal" class="modal-overlay">
                <div class="modal-box">
                    <h3><i class="fas fa-triangle-exclamation text-danger"></i> Xác nhận xóa</h3>
                    <p id="deleteText"></p>
                    <form id="deleteForm" method="POST">
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash-alt"></i> Xác nhận
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelBtn">
                                <i class="fas fa-times"></i> Hủy
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bootstrap JS -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script src="/javascripts/devices.js"></script>
</body>

</html>

                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
