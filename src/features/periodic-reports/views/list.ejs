<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh sách báo cáo định kỳ</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/stylesheets/style.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-acceptance th { background-color: #e9ecef; }
        .table-acceptance th, .table-acceptance td { vertical-align: middle; font-size: 0.9rem; }
        .filter-section { margin-bottom: 20px; }
    </style>
    <!-- <style>
        .app-shell {
            display: flex;
            width: 100%;
        }

        /* Sidebar của bạn mặc định rộng 230px */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 230px);
        }

        .page-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .status-completed { background: #d1e7dd; color: #0f5132; }
        .status-pending { background: #fff3cd; color: #664d03; }
        .status-rejected { background: #f8d7da; color: #842029; }

        .btn-register {
            background-color: var(--primary-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            text-decoration: none;
        }

        .controls { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 15px; 
            align-items: center; 
        }

        .controls .left { display: flex; gap: 10px; }
    </style> -->
</head>

<body>
    <% const userObj = (typeof user !== 'undefined' && user) ? user : { role: 'ql_thiet_bi' }; %>
    <!-- Header -->
    <%- include('../../../views/partials/header', { currentPage: 'periodic-reports', user: userObj }) %>

    <div class="container-fluid p-0">
      <div class="row g-0">
        <%- include('../../../views/partials/qltb-sidebar', { currentPage: 'periodic-reports', user: userObj }) %>

        <div class="col-md-9 col-lg-10 main-content">
          <div class="container py-4">

            <div class="page-header">
                <h1>Quản lý báo cáo định kỳ</h1>
            </div>

            <!-- Bộ lọc -->
            <div class="controls">
                <div class="left">
                    <select id="period-filter" class="form-select" style="width:220px;">
                        <option value="">Tất cả kỳ báo cáo</option>

                        <% (periods || []).forEach(p => { %>
                            <option value="<%= p %>"><%= p %></option>
                        <% }) %>
                    </select>

                    <button id="period-filter-btn" class="btn btn-outline-primary">Lọc</button>
                </div>

                <a href="/manager/periodic-reports/create" class="btn-register">+ Lập báo cáo mới</a>
            </div>


            <!-- TABLE -->
            <div class="card">
                <div class="card-body">

                    <% if (reports && reports.length > 0) { %>

                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>Mã Báo Cáo</th>
                                        <th>Kỳ Báo Cáo</th>
                                        <th>Ngày Lập</th>
                                        <th>Trạng Thái</th>
                                        <th>Tên File</th>
                                        <th class="text-end">Thao tác</th>
                                    </tr>
                                </thead>

                                <tbody id="reports-tbody">
                                    <% reports.forEach(report => { %>
                                        <tr data-period="<%= report.period %>">
                                            <td><%= report.code %></td>
                                            <td><%= report.period %></td>
                                            <td><%= report.date %></td>

                                            <td>
                                                <% if (report.status === 'completed') { %>
                                                    <span class="status-badge status-completed">Đã hoàn thành</span>
                                                <% } else if (report.status === 'pending') { %>
                                                    <span class="status-badge status-pending">Đang chờ duyệt</span>
                                                <% } else if (report.status === 'rejected') { %>
                                                    <span class="status-badge status-rejected">Từ chối</span>
                                                <% } %>
                                            </td>

                                            <td><%= report.fileName || 'Không có file' %></td>

                                            <td class="text-end">
                                                 <% if (report.status === 'pending') { %>
                                                    <form action="/manager/periodic-reports/<%= report.id %>/delete"
                                                        method="post"
                                                        style="display:inline-block;">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                                                onclick="return confirm('Bạn có chắc xóa <%= report.code %>?');">
                                                            Xóa
                                                        </button>
                                                    </form>
                                                <% } %>
                                                <a href="/manager/periodic-reports/<%= report.id %>" class="btn btn-sm btn-outline-primary">Xem</a>
                                                <a href="/manager/periodic-reports/<%= report.id %>/download" class="btn btn-sm btn-outline-success">Tải</a>

                                               
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>

                        <div id="no-results" class="alert alert-warning mt-3" style="display:none;">
                            Không có báo cáo cho kỳ đã chọn.
                        </div>

                    <% } else { %>
                        <div class="alert alert-info">Chưa có báo cáo định kỳ nào.</div>
                    <% } %>

                </div>
         
    </div>

    <script src="/js/bootstrap.bundle.min.js"></script>

    <script>
        // Lọc theo kỳ báo cáo
        const select = document.getElementById("period-filter");
        const btn = document.getElementById("period-filter-btn");
        const tbody = document.getElementById("reports-tbody");
        const noRes = document.getElementById("no-results");

        if (btn && select && tbody) {
            btn.addEventListener("click", () => {
                const val = select.value;
                const rows = tbody.querySelectorAll("tr");
                let any = false;

                rows.forEach(r => {
                    const p = r.getAttribute("data-period");
                    if (!val || p === val) {
                        r.style.display = "";
                        any = true;
                    } else {
                        r.style.display = "none";
                    }
                });

                noRes.style.display = any ? "none" : "block";
            });
        }
    </script>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('../../../views/partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>