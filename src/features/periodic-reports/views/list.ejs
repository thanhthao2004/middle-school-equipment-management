<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/stylesheets/style.css" rel="stylesheet">
    <!-- Reusing Disposal Styles -->
    <link href="/stylesheets/periodic-reports.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <% const userObj=(typeof user !=='undefined' && user) ? user : { role: 'ql_thiet_bi' }; %>

        <!-- Header -->
        <%- include('../../../views/partials/header', { currentPage: 'periodic-reports' , user: userObj }) %>

            <div class="container-fluid p-0">
                <div class="row g-0">
                    <!-- Sidebar -->
                    <%- include('../../../views/partials/qltb-sidebar', { currentPage: 'periodic-reports' , user:
                        userObj }) %>

                        <!-- Main Content -->
                        <div class="col-md-9 col-lg-10 main-content">
                            <div class="container-fluid py-4">

                                <!-- Page Header -->
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h1 class="h3 mb-0">QUẢN LÝ BÁO CÁO ĐỊNH KỲ</h1>
                                    <a href="/manager/periodic-reports/create" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Lập báo cáo mới
                                    </a>
                                </div>

                                <!-- Filters / Controls -->
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <div class="row g-2 align-items-center">
                                            <div class="col-md-4">
                                                <select id="period-filter" class="form-select"
                                                    style="border-radius: 99px;">
                                                    <option value="">Tất cả kỳ báo cáo</option>
                                                    <% (periods || []).forEach(p=> { %>
                                                        <option value="<%= p %>">
                                                            <%= p %>
                                                        </option>
                                                        <% }) %>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <button id="period-filter-btn" class="btn btn-outline-primary w-100"
                                                    style="border-radius: 99px;">
                                                    <i class="fas fa-filter"></i> Lọc
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Table -->
                                <div class="card">
                                    <div class="card-body p-0">
                                        <% if (reports && reports.length> 0) { %>
                                            <div class="table-responsive">
                                                <table class="table table-hover align-middle mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Mã báo cáo</th>
                                                            <th>Kỳ báo cáo</th>
                                                            <th>Ngày lập</th>
                                                            <th class="text-center">Trạng thái</th>
                                                            <th class="text-center">Thao tác</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="reports-tbody">
                                                        <% reports.forEach(report=> { %>
                                                            <tr data-period="<%= report.period %>">
                                                                <td>
                                                                    <span class="code-box"
                                                                        style="background: #eef2ff; color: #1e40af; border-left: 3px solid #6366f1; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                                                                        <%= report.code %>
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <span class="fw-medium text-success">
                                                                        <%= report.period %>
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <%= report.date %>
                                                                </td>

                                                                <td class="text-center">
                                                                    <% if (report.status==='completed' ) { %>
                                                                        <span
                                                                            class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3">Đã
                                                                            duyệt</span>
                                                                        <% } else if (report.status==='pending' ) { %>
                                                                            <span
                                                                                class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill px-3">Chờ
                                                                                duyệt</span>
                                                                            <% } else if (report.status==='rejected' ) {
                                                                                %>
                                                                                <span
                                                                                    class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3">Từ
                                                                                    chối</span>
                                                                                <% } %>
                                                                </td>

                                                                <td class="text-center">
                                                                    <div class="d-flex justify-content-center gap-2">
                                                                        <a href="/manager/periodic-reports/<%= report.id %>"
                                                                            class="btn btn-sm btn-outline-primary"
                                                                            title="Xem chi tiết">
                                                                            <i class="fas fa-eye"></i>
                                                                        </a>

                                                                        <% if (report.fileUrl) { %>
                                                                            <a href="/manager/periodic-reports/<%= report.id %>/download"
                                                                                class="btn btn-sm btn-outline-success"
                                                                                title="Tải file">
                                                                                <i class="fas fa-download"></i>
                                                                            </a>
                                                                            <% } %>

                                                                                <% if (report.status==='pending' ) { %>
                                                                                    <form
                                                                                        action="/manager/periodic-reports/<%= report.id %>/delete"
                                                                                        method="post"
                                                                                        onsubmit="return confirm('Bạn có chắc muốn xóa báo cáo <%= report.code %>?');">
                                                                                        <button type="submit"
                                                                                            class="btn btn-sm btn-outline-danger"
                                                                                            title="Xóa">
                                                                                            <i
                                                                                                class="fas fa-trash-alt"></i>
                                                                                        </button>
                                                                                    </form>
                                                                                    <% } %>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            <% }) %>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <div id="no-results" class="alert alert-warning m-3 text-center"
                                                style="display:none;">
                                                <i class="fas fa-search me-2"></i> Không tìm thấy báo cáo nào phù hợp
                                                với bộ lọc.
                                            </div>

                                            <% } else { %>
                                                <div class="text-center p-5 text-muted">
                                                    <i
                                                        class="fas fa-folder-open fa-3x mb-3 text-secondary opacity-50"></i>
                                                    <p>Chưa có báo cáo định kỳ nào được tạo.</p>
                                                    <a href="/manager/periodic-reports/create"
                                                        class="btn btn-primary mt-2">
                                                        <i class="fas fa-plus"></i> Tạo báo cáo ngay
                                                    </a>
                                                </div>
                                                <% } %>
                                    </div>
                                </div>

                            </div>
                        </div>
                </div>
            </div>

            <%- include('../../../views/partials/footer') %>

                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

                <script>
                    // Client-side filtering logic
                    document.addEventListener('DOMContentLoaded', function () {
                        const select = document.getElementById("period-filter");
                        const btn = document.getElementById("period-filter-btn");
                        const tbody = document.getElementById("reports-tbody");
                        const noRes = document.getElementById("no-results");

                        if (btn && select && tbody) {
                            btn.addEventListener("click", () => {
                                const val = select.value;
                                const rows = tbody.querySelectorAll("tr");
                                let hasVisible = false;

                                rows.forEach(r => {
                                    const p = r.getAttribute("data-period");
                                    if (!val || p === val) {
                                        r.style.display = "";
                                        hasVisible = true;
                                    } else {
                                        r.style.display = "none";
                                    }
                                });

                                if (noRes) noRes.style.display = hasVisible ? "none" : "block";
                            });
                        }
                    });
                </script>
</body>

</html>